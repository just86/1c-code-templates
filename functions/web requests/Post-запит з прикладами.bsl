// <function_purpose>Назначение: Создание структуры параметров для выполнения POST-запроса с JSON</function_purpose>
// <returns>Возвращаемое: Структура – Структура с параметрами запроса</returns>
// <notes>Примечания: Данные - структура для преобразования в JSON. Кодировка по умолчанию CESU8. Content-Length рассчитывается автоматически</notes>
Функция ПараметрыПостЗапроса() Экспорт
	
	Параметры = Новый Структура;
	Параметры.Вставить("Адрес", "");
	Параметры.Вставить("Данные", Новый Структура);
	Параметры.Вставить("Логин", "");
	Параметры.Вставить("Пароль", "");
	Параметры.Вставить("Таймаут", 30);
	Параметры.Вставить("ДополнительныеЗаголовки", Новый Соответствие);
	Параметры.Вставить("Кодировка", "CESU-8");
	
	Возврат Параметры;
	
КонецФункции

// <function_purpose>Назначение: Выполнение POST-запроса с JSON-данными к веб-сервису</function_purpose>
// <parameters>Параметры: ПараметрыФункции – Структура – Параметры запроса (Адрес, Данные, Логин, Пароль, Таймаут, ДополнительныеЗаголовки, Кодировка)</parameters>
// <returns>Возвращаемое: Структура – Структура с результатом запроса (Успех, КодСостояния, Тело, ТелоJSON, Заголовки, ОписаниеОшибки)</returns>
// <notes>Примечания: Данные автоматически преобразуются в JSON. Content-Type и Content-Length устанавливаются автоматически. Ответ парсится как JSON в поле ТелоJSON</notes>
Функция ВыполнитьПостЗапрос(ПараметрыФункции) Экспорт
	
	Если НЕ ПараметрыФункции.Свойство("Адрес") ИЛИ НЕ ЗначениеЗаполнено(ПараметрыФункции.Адрес) Тогда
		Возврат СоздатьРезультатЗапроса(Ложь, 0, "", Новый Соответствие, "Не указан адрес запроса");
	КонецЕсли;
	
	Если НЕ ПараметрыФункции.Свойство("Данные") Тогда
		Возврат СоздатьРезультатЗапроса(Ложь, 0, "", Новый Соответствие, "Не указаны данные для отправки");
	КонецЕсли;
	
	Попытка
		
		СтруктураАдреса = СтруктураURI(ПараметрыФункции.Адрес);
		
	Исключение
		
		Возврат СоздатьРезультатЗапроса(Ложь, 0, "", Новый Соответствие, "Ошибка разбора адреса: " + ОписаниеОшибки());
		
	КонецПопытки;
	
	Сервер = СтруктураАдреса.Хост;
	Порт = ?(ЗначениеЗаполнено(СтруктураАдреса.Порт), СтруктураАдреса.Порт, 
	         ?(НРег(СтруктураАдреса.Схема) = "https", 443, 80));
	
	ИспользоватьSSL = НРег(СтруктураАдреса.Схема) = "https";
	
	ПутьНаСервере = СтруктураАдреса.ПутьНаСервере;
	Если НЕ ЗначениеЗаполнено(ПутьНаСервере) Тогда
		ПутьНаСервере = "/";
	КонецЕсли;
	
	Таймаут = ?(ПараметрыФункции.Свойство("Таймаут"), ПараметрыФункции.Таймаут, 30);
	
	ИмяКодировки = ?(ПараметрыФункции.Свойство("Кодировка"), ПараметрыФункции.Кодировка, "CESU-8");
	
	Попытка
		
		Кодировка = КодировкаТекста[СтрЗаменить(ИмяКодировки, "-", "")];
		
	Исключение
		
		Возврат СоздатьРезультатЗапроса(Ложь, 0, "", Новый Соответствие, "Неизвестная кодировка: " + ИмяКодировки);
		
	КонецПопытки;
	
	JSONСтрока = СформироватьУниверсальныйJSON(ПараметрыФункції.Данные);
	
	Если НЕ ЗначениеЗаполнено(JSONСтрока) Тогда
		Возврат СоздатьРезультатЗапроса(Ложь, 0, "", Новый Соответствие, "Ошибка преобразования данных в JSON");
	КонецЕсли;
	
	ДвоичныеДанныеТела = ПолучитьДвоичныеДанныеИзСтроки(JSONСтрока, Кодировка);
	РазмерТела = ДвоичныеДанныеТела.Размер();
	
	Попытка
		
		Соединение = Новый HTTPСоединение(
			Сервер,
			Порт,
			ПараметрыФункции.Логин,
			ПараметрыФункции.Пароль,
			,
			Таймаут,
			?(ИспользоватьSSL, Новый ЗащищенноеСоединениеOpenSSL, Неопределено)
		);
		
		Запрос = Новый HTTPЗапрос(ПутьНаСервере);
		
		Запрос.Заголовки.Вставить("Content-Type", "application/json; charset=" + ИмяКодировки);
		Запрос.Заголовки.Вставить("Content-Length", Формат(РазмерТела, "ЧГ=0"));
		
		Если ПараметрыФункции.Свойство("ДополнительныеЗаголовки") Тогда
			
			Для Каждого Заголовок Из ПараметрыФункции.ДополнительныеЗаголовки Цикл
				Запрос.Заголовки.Вставить(Заголовок.Ключ, Заголовок.Значение);
			КонецЦикла;
			
		КонецЕсли;
		
		Запрос.УстановитьТелоИзДвоичныхДанных(ДвоичныеДанныеТела);
		
		Ответ = Соединение.ВызватьHTTPМетод("POST", Запрос);
		
		КодСостояния = Ответ.КодСостояния;
		ТелоОтвета = Ответ.ПолучитьТелоКакСтроку(Кодировка);
		ЗаголовкиОтвета = Ответ.Заголовки;
		
		Успех = (КодСостояния >= 200) И (КодСостояния <= 299);
		
		ОписаниеОшибки = "";
		Если НЕ Успех Тогда
			ОписаниеОшибки = "HTTP " + КодСостояния;
		КонецЕсли;
		
		РезультатЗапроса = СоздатьРезультатЗапроса(Успех, КодСостояния, ТелоОтвета, ЗаголовкиОтвета, ОписаниеОшибки);
		
		Если Успех Тогда
			
			ТелоJSON = ПрочитатьУниверсальныйJSON(ТелоОтвета);
			
			Если ТелоJSON <> Неопределено Тогда
				РезультатЗапроса.Вставить("ТелоJSON", ТелоJSON);
			Иначе
				РезультатЗапроса.Вставить("ТелоJSON", Неопределено);
			КонецЕсли;
			
		КонецЕсли;
		
		Возврат РезультатЗапроса;
		
	Исключение
		
		Возврат СоздатьРезультатЗапроса(Ложь, 0, "", Новый Соответствие, "Ошибка выполнения запроса: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецФункции